<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===============================
   CONFIGURATION SAFE SUPABASE
================================ */

let supabaseClient = null;

try {
  if (window.supabase) {
    const { createClient } = window.supabase;
    supabaseClient = createClient(
      'https://cxvetkmbhohutyprwxjx.supabase.co',
      'TA_CLE_ICI'
    );
    console.log("‚úÖ Supabase connect√©");
  }
} catch (e) {
  console.warn("‚ö†Ô∏è Supabase indisponible, mode local activ√©.");
}

/* ===============================
   NAVIGATION (ind√©pendant backend)
================================ */

window.goHome = function() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('home').classList.add('active');
};

window.goToForm = function() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('form').classList.add('active');
};

window.goToArticles = function() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('articles').classList.add('active');
  chargerArticles();
};

window.goToAdmin = function() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('admin').classList.add('active');
};

/* ===============================
   INSCRIPTION SAFE
================================ */

window.envoyerWhatsApp = async function() {
  const nom = document.getElementById('nom').value.trim();
  const prenom = document.getElementById('prenom').value.trim();
  const tel = document.getElementById('telephone').value.trim();
  const nat = document.getElementById('nationalite').value.trim();

  if(!nom || !prenom || !tel || !nat) {
    alert("‚ùå Tous les champs sont requis");
    return;
  }

  const inscription = { nom, prenom, telephone: tel, nationalite: nat };

  // ‚úÖ Si Supabase dispo
  if (supabaseClient) {
    try {
      await supabaseClient.from('inscriptions').insert([inscription]);
      alert("‚úÖ Inscription enregistr√©e en ligne !");
    } catch (e) {
      console.warn("Erreur Supabase, sauvegarde locale.");
      saveLocal(inscription);
    }
  } else {
    saveLocal(inscription);
  }

  const msg = `Nouvelle inscription ARJAP
Nom: ${nom}
Pr√©nom: ${prenom}
T√©l: ${tel}
Nationalit√©: ${nat}`;

  window.open(`https://wa.me/237653375470?text=${encodeURIComponent(msg)}`, '_blank');
};

function saveLocal(data) {
  let localData = JSON.parse(localStorage.getItem('arjap_inscriptions')) || [];
  localData.push({ ...data, created_at: new Date() });
  localStorage.setItem('arjap_inscriptions', JSON.stringify(localData));
  alert("‚ö†Ô∏è Sauvegard√© localement (hors ligne)");
}

/* ===============================
   ARTICLES SAFE
================================ */

window.chargerArticles = async function() {
  const container = document.getElementById('articles-list');
  if(!container) return;

  container.innerHTML = "Chargement...";

  if (supabaseClient) {
    try {
      const { data } = await supabaseClient
        .from('publications')
        .select('*')
        .order('created_at', { ascending: false });

      if(data && data.length > 0) {
        displayArticles(data);
        return;
      }
    } catch (e) {
      console.warn("Erreur Supabase, chargement local.");
    }
  }

  // fallback localStorage
  const localData = JSON.parse(localStorage.getItem('arjap_articles')) || [];
  displayArticles(localData);
};

function displayArticles(data) {
  const container = document.getElementById('articles-list');

  if(!data || data.length === 0) {
    container.innerHTML = "<p>Aucune publication.</p>";
    return;
  }

  let html = "";
  data.forEach(a => {
    html += `
      <div class="article-card">
        <h3>${escapeHtml(a.titre || "")}</h3>
        <p>${escapeHtml(a.contenu || "")}</p>
      </div>
    `;
  });

  container.innerHTML = html;
}

/* ===============================
   PUBLIER ARTICLE SAFE
================================ */

window.publierArticle = async function() {
  const titre = document.getElementById('admin-title').value.trim();
  const contenu = document.getElementById('admin-content').value.trim();

  if(!titre || !contenu) {
    alert("‚ùå Remplis tous les champs");
    return;
  }

  const article = { titre, contenu, created_at: new Date() };

  if (supabaseClient) {
    try {
      await supabaseClient.from('publications').insert([article]);
      alert("‚úÖ Publi√© en ligne");
    } catch (e) {
      saveArticleLocal(article);
    }
  } else {
    saveArticleLocal(article);
  }

  chargerArticles();
};

function saveArticleLocal(article) {
  let localData = JSON.parse(localStorage.getItem('arjap_articles')) || [];
  localData.push(article);
  localStorage.setItem('arjap_articles', JSON.stringify(localData));
  alert("‚ö†Ô∏è Article sauvegard√© localement");
}

/* ===============================
   PROTECTION XSS
================================ */

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

console.log("üî• ARJAP pr√™t - Mode r√©silient activ√© !");
</script>
